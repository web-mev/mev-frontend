<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>web-mev documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">web-mev documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li>OperationCategoryNode</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>projects/web-mev/src/app/features/analysis/components/executed-operation/executed-operation.component.ts</code>
        </p>

            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>Operation category with nested structure.
Each node has a name and an optional list of children.</p>

            </p>


        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#children">children</a>
                                </li>
                                <li>
                                        <a href="#name">name</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="children"></a>
                                        <span class="name"><b>children</b><a href="#children"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>children:         <code><a href="../classes/Operation.html" target="_self" >Operation[]</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="../classes/Operation.html" target="_self" >Operation[]</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="name"></a>
                                        <span class="name"><b>name</b><a href="#name"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>name:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import {
  Component,
  OnInit,
  ChangeDetectionStrategy,
  Input
} from &#x27;@angular/core&#x27;;
import { ActivatedRoute } from &#x27;@angular/router&#x27;;
import { AnalysesService } from &#x27;../../services/analysis.service&#x27;;
import { switchMap, tap } from &#x27;rxjs/operators&#x27;;
import { of, Subscription } from &#x27;rxjs&#x27;;
import { FlatTreeControl } from &#x27;@angular/cdk/tree&#x27;;
import { Operation } from &#x27;../../models/operation&#x27;;
import {
  MatTreeFlattener,
  MatTreeFlatDataSource
} from &#x27;@angular/material/tree&#x27;;

/**
 * Operation category with nested structure.
 * Each node has a name and an optional list of children.
 */
interface OperationCategoryNode {
  name: string;
  children?: Operation[];
}

/**
 * Flat node with expandable and level information
 */
interface ExampleFlatNode {
  expandable: boolean;
  name: string;
  level: number;
}

/**
 * Presentational states of operation execution process
 */
enum operationExecution {
  InProcess,
  RunningAnalysis,
  PreparingData,
  Finished
}

/**
 * Executed Operation Component
 * used for displaying the list of executed operations (tree) and their results
 */

@Component({
  selector: &#x27;mev-executed-operation&#x27;,
  templateUrl: &#x27;./executed-operation.component.html&#x27;,
  styleUrls: [&#x27;./executed-operation.component.scss&#x27;],
  changeDetection: ChangeDetectionStrategy.Default
})
export class ExecutedOperationComponent implements OnInit {
  private executedOperationResultSubscription: Subscription &#x3D; new Subscription();
  execOperations;
  execOperationResult;
  selectedExecOperationId: string;
  selectedExecOperationName: string;
  data;

  @Input() execOperationId: string;
  outputs;
  operationExecutionStateType &#x3D; operationExecution;
  operationExecutionState: operationExecution;
  categories &#x3D; new Set();
  subcategories &#x3D; [];

  activeNode: Operation;
  treeControl &#x3D; new FlatTreeControl&lt;ExampleFlatNode&gt;(
    node &#x3D;&gt; node.level,
    node &#x3D;&gt; node.expandable
  );

  hasChild &#x3D; (_: number, node: ExampleFlatNode) &#x3D;&gt; node.expandable;

  private _transformer &#x3D; (node: OperationCategoryNode, level: number) &#x3D;&gt; {
    return {
      expandable: !!node.children &amp;&amp; node.children.length &gt; 0,
      level: level,
      ...node
    };
  };

  treeFlattener &#x3D; new MatTreeFlattener(
    this._transformer,
    node &#x3D;&gt; node.level,
    node &#x3D;&gt; node.expandable,
    node &#x3D;&gt; node.children
  );

  dataSource &#x3D; new MatTreeFlatDataSource(this.treeControl, this.treeFlattener);

  constructor(
    private route: ActivatedRoute,
    private apiService: AnalysesService
  ) {}

  /**
   * Initialize the datasource for the Operation Tree
   */
  ngOnInit(): void {
    const operationTree &#x3D; {};
    const workspaceId &#x3D; this.route.snapshot.paramMap.get(&#x27;workspaceId&#x27;);
    this.executedOperationResultSubscription &#x3D; this.apiService
      .getExecOperations(workspaceId)
      .pipe(
        tap(operations &#x3D;&gt; {
          this.execOperations &#x3D; operations;
          operations.forEach(execOperation &#x3D;&gt; {
            execOperation &#x3D; { ...execOperation, name: execOperation.job_name };
            const categories &#x3D; execOperation.operation.categories;
            const operation &#x3D; execOperation.operation.operation_name;
            categories.forEach(category &#x3D;&gt; {
              if (category in operationTree) {
                const level &#x3D; operationTree[category];
                if (operation in level) {
                  level[operation].push(execOperation);
                } else {
                  level[operation] &#x3D; [execOperation];
                }
              } else {
                const level &#x3D; {};
                level[operation] &#x3D; [execOperation];
                operationTree[category] &#x3D; level;
              }
            });
            const operationTreeArr &#x3D; [];
            for (const elem in operationTree) {
              const categoryLevel &#x3D; { name: elem, children: [] };
              for (const subElem in operationTree[elem]) {
                categoryLevel.children.push({
                  name: subElem,
                  children: operationTree[elem][subElem]
                });
              }
              operationTreeArr.push(categoryLevel);
            }
            operationTreeArr.sort(function(a, b) {
              var nameA &#x3D; a.name.toUpperCase();
              var nameB &#x3D; b.name.toUpperCase();
              if (nameA &lt; nameB) {
                return -1;
              }
              if (nameA &gt; nameB) {
                return 1;
              }
              return 0;
            });
            this.dataSource.data &#x3D; operationTreeArr.sort();
          });
        }),
        switchMap(() &#x3D;&gt; {
          if (this.execOperationId) {
            this.operationExecutionState &#x3D; operationExecution.InProcess;

            this.selectedExecOperationId &#x3D; this.execOperationId;
            const execOperation &#x3D; this.getExecOperationByOperationId(
              this.execOperationId
            );

            // expand the parent nodes if there is an operation selected
            const nodesToExpand &#x3D; [
              execOperation.operation.operation_name,
              ...execOperation.operation.categories
            ];
            this.treeControl.dataNodes.forEach((node, i) &#x3D;&gt; {
              if (nodesToExpand.includes(node.name)) {
                this.treeControl.expand(this.treeControl.dataNodes[i]);
              }
            });
            this.activeNode &#x3D; execOperation;
            this.selectedExecOperationName &#x3D; execOperation.job_name;

            // if the opertion has been already completed, just extract its data from the list
            if (execOperation?.outputs || execOperation?.error_messages) {
              this.outputs &#x3D; {
                operation: execOperation.operation,
                job_name: execOperation.job_name,
                ...execOperation.outputs,
                ...execOperation.inputs,
                error_messages: execOperation.error_messages
              };
              return of({ body: execOperation });
            }

            return this.apiService.getExecutedOperationResult(
              this.execOperationId
            );
          }
          return of();
        })
      )
      .subscribe((response: any) &#x3D;&gt; {
        this.updateOperationExecutionState(response.status);
        this.outputs &#x3D; {
          operation: response?.body?.operation,
          job_name: response?.body?.job_name,
          ...response?.body?.outputs,
          ...response?.body?.inputs,
          error_messages: response?.body?.error_messages
        };
      });
  }

  /**
   * Find the operation data by OperationID
   */
  getOutputs(operationId) {
    const idx &#x3D; this.execOperations.findIndex(val &#x3D;&gt; val.id &#x3D;&#x3D;&#x3D; operationId);
    return this.execOperations[idx].outputs;
  }

  /**
   * Function is triggered when the user selects an operation in the tree
   */
  onSelectExecOperation(execOperation) {
    this.activeNode &#x3D; execOperation;
    this.operationExecutionState &#x3D; operationExecution.InProcess;

    this.executedOperationResultSubscription.unsubscribe();
    this.execOperationId &#x3D; execOperation.id;
    this.selectedExecOperationName &#x3D; execOperation.job_name;

    // if the operation has been already completed, just extract its data from the list
    if (execOperation.outputs || execOperation.error_messages) {
      this.outputs &#x3D; {
        operation: execOperation.operation,
        job_name: execOperation.job_name,
        ...execOperation.outputs,
        ...execOperation.inputs,
        error_messages: execOperation.error_messages
      };
      this.operationExecutionState &#x3D; operationExecution.Finished;
    } else {
      this.executedOperationResultSubscription &#x3D; this.apiService
        .getExecutedOperationResult(this.execOperationId)
        .subscribe(response &#x3D;&gt; {
          this.outputs &#x3D; {
            operation: response?.body?.operation,
            job_name: response?.body?.job_name,
            ...response?.body?.outputs,
            ...response?.body?.inputs,
            error_messages: response?.body?.error_messages
          };

          this.updateOperationExecutionState(response.status);
        });
    }
  }

  /**
   * Update the operation execution state depending on the server response
   */
  updateOperationExecutionState(status) {
    if (status &#x3D;&#x3D;&#x3D; 204) {
      this.operationExecutionState &#x3D; operationExecution.RunningAnalysis;
    } else if (status &#x3D;&#x3D;&#x3D; 202 || status &#x3D;&#x3D;&#x3D; 208) {
      this.operationExecutionState &#x3D; operationExecution.PreparingData;
    } else {
      this.operationExecutionState &#x3D; operationExecution.Finished;
      this.execOperations.filter(
        op &#x3D;&gt; op.id &#x3D;&#x3D;&#x3D; this.execOperationId
      )[0].execution_stop_datetime &#x3D; new Date();
    }
  }

  /**
   * Function to check if an operation failed
   */
  isOperationFailed(operation): boolean {
    return operation.job_failed;
  }

  /**
   * Function to check if an operation is still executing
   */
  isOperationExecuting(operation): boolean {
    if (operation.execution_stop_datetime) return false;

    // if execution_stop_datetime is null, check if the list of operations has an updated value
    const arr &#x3D; this.execOperations.filter(op &#x3D;&gt; op.id &#x3D;&#x3D;&#x3D; operation.id);
    if (arr.length) {
      return !arr[0].execution_stop_datetime;
    }
    return true;
  }

  getExecOperationByOperationId(operationId: string) {
    const idx &#x3D; this.execOperations.findIndex(val &#x3D;&gt; val.id &#x3D;&#x3D;&#x3D; operationId);
    return this.execOperations[idx];
  }

  public ngOnDestroy(): void {
    this.executedOperationResultSubscription.unsubscribe();
  }
}
</code></pre>
    </div>
</div>


                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'OperationCategoryNode-1.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
